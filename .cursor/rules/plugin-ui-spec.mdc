---
description: plugin UI specs
alwaysApply: false
---
## Interface 1: Command Palette

### Purpose
Quick, inline actions that feel like autocomplete. Similar to Notion, Slack, or modern editors.

### Trigger Behavior

User types trigger character anywhere in markdown:
- `/` â†’ Show commands
- `@` â†’ Show agents, files, folders

### UX Flow

#### Step 1: User Types Trigger

```markdown
Some content...
/|
```

**Initial state:**
- Show recently used commands
- Or show nothing and wait for next character

#### Step 2: User Types More Characters

```markdown
Some content...
/sum|
```

**Update list in real-time:**
- Fuzzy match on every keystroke
- Show matching commands, agents, files
- Ranked by relevance

#### Step 3: User Selects from List

```markdown
Some content...
/summarize
```

**On selection:**
- Insert selected text into document
- Close palette
- Daemon will detect and process

### Visual Design

**Notion-style floating menu:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ /sum                            [x] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ¨ /summarize                       â”‚
â”‚    Create a summary of content      â”‚
â”‚                                     â”‚
â”‚ ğŸ“Š /summary-report                  â”‚
â”‚    Generate detailed summary report â”‚
â”‚                                     â”‚
â”‚ ğŸ“ @summer-notes.md                 â”‚
â”‚    notes/summer-notes.md            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key elements:**
- **Search box** at top (shows what user typed)
- **Categorized results** (Commands, Agents, Files)
- **Icons** for visual distinction
- **Descriptions** to help user choose
- **Path hints** for files (show location)

### Fuzzy Matching

**Match on:**
- Command/agent ID
- Command/agent name
- File name (with and without extension)
- Folder paths
- Command descriptions

**Ranking algorithm:**
```typescript
interface MatchResult {
  item: Command | Agent | File | Folder;
  score: number;
  matchType: 'exact' | 'prefix' | 'fuzzy' | 'description';
}

function rankMatches(query: string, items: Item[]): MatchResult[] {
  return items
    .map(item => ({
      item,
      score: calculateScore(query, item),
      matchType: determineMatchType(query, item)
    }))
    .filter(result => result.score > 0.3) // Threshold
    .sort((a, b) => {
      // Priority: exact > prefix > fuzzy > description
      if (a.matchType !== b.matchType) {
        return matchTypePriority[a.matchType] - matchTypePriority[b.matchType];
      }
      // Within same type, sort by score
      return b.score - a.score;
    });
}

function calculateScore(query: string, item: Item): number {
  const q = query.toLowerCase();
  const name = item.name.toLowerCase();
  
  // Exact match
  if (name === q) return 1.0;
  
  // Starts with query
  if (name.startsWith(q)) return 0.9;
  
  // Contains query
  if (name.includes(q)) return 0.7;
  
  // Fuzzy match (all characters present in order)
  const fuzzyScore = fuzzyMatch(q, name);
  if (fuzzyScore > 0) return 0.5 * fuzzyScore;
  
  // Match in description
  if (item.description?.toLowerCase().includes(q)) return 0.4;
  
  return 0;
}
```

### Context-Aware Suggestions

**Boost relevance based on:**

1. **Recently used** (last 10 commands/agents)
2. **Current file context** (if editing finance doc, boost @betty)
3. **Proximity** (files in same folder ranked higher)
4. **Frequency** (track usage over time)

```typescript
interface SuggestionContext {
  currentFile: string;
  recentlyUsed: string[];
  usageFrequency: Record<string, number>;
}

function adjustScoresWithContext(
  results: MatchResult[],
  context: SuggestionContext
): MatchResult[] {
  return results.map(result => {
    let boost = 0;
    
    // Recently used
    const recentIndex = context.recentlyUsed.indexOf(result.item.id);
    if (recentIndex !== -1) {
      boost += 0.2 * (1 - recentIndex / context.recentlyUsed.length);
    }
    
    // Usage frequency
    const frequency = context.usageFrequency[result.item.id] || 0;
    boost += Math.min(0.1, frequency * 0.01);
    
    // Proximity (for files)
    if (result.item.type === 'file') {
      const distance = calculatePathDistance(context.currentFile, result.item.path);
      boost += 0.15 / (distance + 1);
    }
    
    return {
      ...result,
      score: Math.min(1.0, result.score + boost)
    };
  });
}
```

### Keyboard Navigation

```
â†‘/â†“     - Navigate list
Enter   - Select highlighted item
Esc     - Close palette
Tab     - Cycle through categories
```

### Categories

Results grouped by type:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ /sum                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ COMMANDS                            â”‚
â”‚ âœ¨ /summarize                       â”‚
â”‚ âœ¨ /summary-report                  â”‚
â”‚                                     â”‚
â”‚ AGENTS                              â”‚
â”‚ ğŸ¤– @summer (Intern)                 â”‚
â”‚                                     â”‚
â”‚ FILES                               â”‚
â”‚ ğŸ“ summer-notes.md                  â”‚
â”‚    /vault/notes/summer-notes.md     â”‚
â”‚ ğŸ“ summary-2024.md                  â”‚
â”‚    /vault/finance/summary-2024.md   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Multiple Mentions in One Line

User can type multiple mentions:

```markdown
@betty review @finance/Q4/ comparing with $quickbooks
```

**Palette reopens on each trigger:**

1. User types `@` â†’ palette shows agents
2. User selects `@betty` â†’ palette closes
3. User continues typing `review`
4. User types `@` â†’ palette reopens, shows files/folders
5. User selects `@finance/Q4/` â†’ palette closes
6. User types `$` â†’ palette shows services
7. And so on...

**Each mention is independent autocomplete.**

---

## Interface 2: Chat Widget

### Purpose
Long-running conversational sessions with preserved context. For complex queries that need back-and-forth dialogue.

### Design Inspiration

**Intercom-style floating chat:**

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Spark Assistant        [_][x]â”‚
                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    â”‚                              â”‚
                    â”‚ You: @betty what's our burn  â”‚
                    â”‚ rate for Q4?                 â”‚
                    â”‚                              â”‚
                    â”‚ Betty: Let me analyze your   â”‚
                    â”‚ Q4 finances...               â”‚
                    â”‚                              â”‚
                    â”‚ I've reviewed @finance/Q4/.  â”‚
                    â”‚ Your burn rate is $47K/month â”‚
                    â”‚                              â”‚
                    â”‚ That's a 9.6% reduction from â”‚
                    â”‚ Q3. Good progress!           â”‚
                    â”‚                      14:32   â”‚
                    â”‚                              â”‚
                    â”‚ You: Can you compare with    â”‚
                    â”‚ $quickbooks data?            â”‚
                    â”‚                              â”‚
                    â”‚ â—â—â— Betty is typing...       â”‚
                    â”‚                              â”‚
                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    â”‚ Type a message...        [â†‘] â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Key Features

**1. Persistent Context**
- Full conversation history maintained
- Each message has access to previous messages
- Context grows as conversation continues

**2. Same Mention System**
- Type `@` to mention files, folders, agents
- Type `/` to invoke commands
- Type `$` to reference services
- Autocomplete works same as command palette

**3. File Awareness**
- Always aware of current file (where cursor is in Obsidian)
- Aware of neighboring files
- Aware of parent directory
- Same proximity-based context as command palette

**4. Visual Distinction**
- User messages: Right-aligned, blue
- AI responses: Left-aligned, gray
- Mentions rendered as links/pills
- Timestamps on messages

### Trigger

**Hotkey:** `Cmd+K` (configurable)

Opens floating widget in bottom-right corner of Obsidian.

### Widget Position & Behavior

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Obsidian Window                         â”‚
â”‚                                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚ â”‚ Markdown Editor                 â”‚    â”‚
â”‚ â”‚                                 â”‚    â”‚
â”‚ â”‚ User is editing notes here...   â”‚    â”‚
â”‚ â”‚                                 â”‚    â”‚
â”‚ â”‚                                 â”‚    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                         â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚              â”‚ Spark Chat     [_][x]â”‚   â”‚
â”‚              â”‚                      â”‚   â”‚
â”‚              â”‚ Conversation here... â”‚   â”‚
â”‚              â”‚                      â”‚   â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Draggable, resizable, minimizable.**

### Message Input

**Input box supports:**
- Multi-line input (Shift+Enter for new line)
- Mention autocomplete (same as command palette)
- Markdown formatting (bold, italic, code)
- File attachments (drag & drop to mention files)

**Example:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ @betty review @|                     â”‚
â”‚ â†“ finance/Q4/                        â”‚
â”‚   finance/summary.md                 â”‚
â”‚   compliance-rules.md                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

User types `@`, autocomplete appears inline.

### Message Format

**User messages:**
```markdown
@betty what's our burn rate for Q4?
```

**AI responses:**
```markdown
Let me analyze your Q4 finances...

I've reviewed @finance/Q4/. Your burn rate is $47K/month.

That's a 9.6% reduction from Q3. Good progress!
```

**Mentions rendered as clickable links:**
- Click `@finance/Q4/` â†’ Opens folder in Obsidian
- Click `@betty` â†’ Shows agent info
- Click `$quickbooks` â†’ Shows service status

### Context Management

**Each message has access to:**

1. **Conversation history** (all previous messages)
2. **Current file** (active file in Obsidian)
3. **Mentioned files/folders** (explicitly referenced)
4. **Proximity context** (neighboring files, parent directory)

**Context is loaded fresh on each message** to ensure up-to-date information.

```typescript
interface ChatMessage {
  id: string;
  role: 'user' | 'assistant';
  content: string;
  timestamp: number;
  
  // Context at time of message
  context: {
    currentFile: string;
    mentions: ParsedMention[];
    conversationHistory: ChatMessage[];
  };
}

async function processChat Message(
  message: string,
  sessionId: string
): Promise<string> {
  // Load conversation history
  const history = await loadSession(sessionId);
  
  // Parse mentions in new message
  const mentions = await parseMentions(message);
  
  // Load context (same as command palette)
  const context = await loadContext({
    currentFile: getCurrentActiveFile(),
    mentions: mentions,
    conversationHistory: history
  });
  
  // Build prompt for Claude
  const prompt = buildChatPrompt({
    message,
    context,
    history
  });
  
  // Call Claude
  const response = await claude.complete(prompt);
  
  // Save message to history
  await saveMessage(sessionId, {
    role: 'user',
    content: message,
    context
  });
  
  await saveMessage(sessionId, {
    role: 'assistant',
    content: response,
    context
  });
  
  return response;
}
```

### Session Management

**Each chat session:**
- Has unique ID
- Saved to `.spark/conversations/{date}-{id}.md`
- Persists across Obsidian restarts
- Can be resumed later

**Session list:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Spark Assistant          [â‰¡]   [_][x]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ¨ New Conversation                  â”‚
â”‚                                      â”‚
â”‚ RECENT SESSIONS                      â”‚
â”‚ â— Q4 Finance Review      2 hours ago â”‚
â”‚ â— Client Onboarding      Yesterday   â”‚
â”‚ â— Report Generation      Jan 14      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

Click `[â‰¡]` menu to:
- Start new conversation
- Load recent session
- Search conversation history
- Clear current session

### Integration with Command Palette

**Chat can invoke commands:**

```
You: @betty create a financial report

Betty: I'll create a report for you.
      Executing: /create-report

      âœ“ Report created at @reports/Q4-finance.md
```

**Commands executed inline, results shown in chat.**

### Status Indicators

**AI thinking:**
```
â—â—â— Betty is typing...
```

**Loading context:**
```
ğŸ“‚ Loading 15 files from @finance/Q4/...
```

**Executing command:**
```
âš™ï¸ Executing /create-report...
```

**Error:**
```
âŒ Error: QuickBooks service unavailable
   See error log for details
```

---

## Implementation: Fork Claude Code Integration

### Existing Claude Code for Obsidian

There's already a Claude Code integration plugin for Obsidian. We'll fork it and adapt.

**Changes needed:**

1. **Visual redesign** - Intercom-style chat widget
2. **Context injection** - Add Spark's proximity-based context system
3. **Mention parsing** - Add `@`, `/`, `$` mention support
4. **Session persistence** - Save to `.spark/conversations/`
5. **Agent support** - Load agent personas from `.spark/agents/`

### Fork Strategy

```
Original:
obsidian-claude-code/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ chat-view.ts          # Chat UI
â”‚   â”œâ”€â”€ claude-client.ts      # API client
â”‚   â””â”€â”€ context-loader.ts     # Context loading

Our Fork:
obsidian-spark/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ chat-widget.ts        # NEW: Intercom-style UI
â”‚   â”œâ”€â”€ command-palette.ts    # NEW: Notion-style palette
â”‚   â”œâ”€â”€ mention-parser.ts     # NEW: Parse @, /, $ syntax
â”‚   â”œâ”€â”€ context-loader.ts     # MODIFIED: Proximity-based context
â”‚   â”œâ”€â”€ claude-client.ts      # KEEP: API client (minimal changes)
â”‚   â””â”€â”€ agent-loader.ts       # NEW: Load agent personas
```

### Skinning the Chat Widget

**Current Claude Code UI:**
- Full-screen panel
- Developer-focused
- Minimal styling

**Spark UI:**
- Floating widget (Intercom-style)
- Bottom-right corner
- Polished, modern design
- Draggable, resizable

**CSS/Styling:**
```css
.spark-chat-widget {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 400px;
  height: 600px;
  
  background: var(--background-primary);
  border: 1px solid var(--background-modifier-border);
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
  
  display: flex;
  flex-direction: column;
  
  z-index: 9999;
}

.spark-chat-header {
  padding: 16px;
  border-bottom: 1px solid var(--background-modifier-border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  
  cursor: move; /* Draggable */
}

.spark-chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
}

.spark-message-user {
  text-align: right;
  margin: 8px 0;
}

.spark-message-assistant {
  text-align: left;
  margin: 8px 0;
}

.spark-message-bubble {
  display: inline-block;
  max-width: 80%;
  padding: 12px 16px;
  border-radius: 18px;
  
  /* User: blue */
  background: var(--interactive-accent);
  color: white;
}

.spark-message-assistant .spark-message-bubble {
  /* Assistant: gray */
  background: var(--background-secondary);
  color: var(--text-normal);
}

.spark-chat-input {
  border-top: 1px solid var(--background-modifier-border);
  padding: 16px;
}

.spark-chat-input textarea {
  width: 100%;
  min-height: 60px;
  border: none;
  background: var(--background-primary);
  resize: none;
}
```

---

## Comparison: Command Palette vs Chat Widget

| Feature | Command Palette | Chat Widget |
|---------|----------------|-------------|
| **Trigger** | Type `/` or `@` | Press `Cmd+K` |
| **UI** | Inline dropdown | Floating widget |
| **Lifecycle** | Atomic (one action) | Persistent (conversation) |
| **Context** | Current file + proximity | Same + history |
| **Use Case** | Quick actions | Complex queries |
| **Result** | Written to file | Shown in chat |
| **History** | No history | Full conversation saved |

**Both share:**
- Same mention system (`@`, `/`, `$`)
- Same context loading (proximity-based)
- Same fuzzy matching
- Same agent/command support

---

## Implementation Order

### Phase 1: Command Palette (Week 1-2)
- Basic trigger detection (`/`, `@`)
- Fuzzy matching on commands/files
- Notion-style dropdown UI
- Keyboard navigation

### Phase 2: Context Integration (Week 2-3)
- Load commands from `.spark/commands/`
- Load agents from `.spark/agents/`
- Implement proximity-based file suggestions
- Integrate with daemon (write mentions to file)

### Phase 3: Chat Widget (Week 3-4)
- Fork Claude Code integration
- Redesign UI (Intercom-style)
- Add mention support in chat
- Session persistence

### Phase 4: Polish (Week 4-5)
- Drag & drop for files
- Message formatting (markdown rendering)
- Status indicators
- Error handling
- Settings panel

---

## Configuration

```yaml
# .spark/config.yaml

plugin:
  command_palette:
    enabled: true
    triggers: ["/", "@", "$"]
    max_results: 10
    fuzzy_threshold: 0.3
    show_descriptions: true
    show_paths: true
    
    # Context boosting
    boost_recent_used: 0.2
    boost_frequency: 0.1
    boost_proximity: 0.15
  
  chat_widget:
    enabled: true
    hotkey: "Cmd+K"
    position: "bottom-right"
    default_width: 400
    default_height: 600
    
    # Appearance
    theme: "auto"  # auto | light | dark
    draggable: true
    resizable: true
    minimizable: true
    
    # Behavior
    preserve_context: true
    max_history_messages: 100
    auto_save_session: true
    
    # Agent
    default_agent: null  # null = no agent, or "betty"
```

---

## Summary

**Two interfaces, one system:**

1. **Command Palette** - Fast, inline, autocomplete-style for quick actions
2. **Chat Widget** - Conversational, persistent, for complex workflows

**Both use:**
- Same mention parser
- Same context system
- Same agent/command infrastructure
- Same daemon backend

**Key difference:**
- Palette is atomic (one-shot)
- Chat is conversational (multi-turn)

**User can choose the right tool for the job.**

---

## Next: Implementation Plan

With UI spec complete, we can now plan:
1. **Build order** - What to implement first
2. **Testing strategy** - How to validate each phase
3. **Milestones** - Clear success criteria

Ready to create the implementation plan?
