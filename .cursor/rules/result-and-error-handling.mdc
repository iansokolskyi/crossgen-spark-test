---
description: result handling and error handling
alwaysApply: false
---
## Result Handling

### The Key Insight

When user types:
```markdown
@betty review @finance/Q4/ comparing with $quickbooks, flag any issues in @compliance-rules.md and /create-report
```

The instructions tell Claude to:
1. Review files and compare with QuickBooks
2. Flag issues IN the compliance-rules.md file
3. Execute create-report command (which generates a report file)

**The result IS those actions.** We don't need to write "Here's what I found" back to the original file.

### Completion Indicator

**Before:**
```markdown
Some content...

@betty review @finance/Q4/ comparing with $quickbooks, flag issues in @compliance-rules.md and /create-report

More content...
```

**After (Completed Successfully):**
```markdown
Some content...

✅ @betty review @finance/Q4/ comparing with $quickbooks, flag issues in @compliance-rules.md and /create-report

More content...
```

That's it. The ✅ tells the user it's done.

### Notification

When complete, daemon writes to `.spark/notifications.jsonl`:

```jsonl
{"id": "abc123", "type": "success", "message": "Task completed successfully", "timestamp": 1234567890}
```

Plugin shows toast:
```
┌─────────────────────────────┐
│ ✓ Task completed            │
└─────────────────────────────┘
```

---

## When Results ARE Written

### Case 1: Simple Slash Commands

For simple commands that return information:

**User types:**
```markdown
/summarize
```

**This is a READ operation** - user wants the summary in the file.

**After completion:**
```markdown
✅ /summarize

## Summary
This document discusses quarterly financial performance...
- Revenue increased 15%
- Expenses decreased 8%
- Net profit up 23%
```

### Case 2: Explicit Output Commands

If command definition specifies `output: inline`:

```markdown
---
# .spark/commands/summarize.md
id: summarize
output: inline  # Write result to file
---

Create a summary...
```

Then result is written inline.

### Case 3: Commands That Create Files

If command creates separate files (reports, documents):

```markdown
---
# .spark/commands/create-report.md
id: create-report
output: separate_file  # Creates new file
output_path: reports/
---

Create a comprehensive report and save to reports/ folder...
```

**After completion:**
```markdown
✅ /create-report

Report created: @reports/Q4-analysis.md
```

Just a link to the created file, not the full content.

---

## Notification System

### Notification Types

```typescript
interface Notification {
  id: string;
  type: 'success' | 'error' | 'warning' | 'info' | 'progress';
  message: string;
  timestamp: number;
  
  // Optional fields
  file?: string;              // Which file triggered this
  line?: number;              // Line number in file
  link?: string;              // Link to log file or result
  progress?: number;          // 0-1 for long operations
  action?: {
    label: string;
    command: string;
  };
}
```

### Display Options

**Option 1: Obsidian Toast (Preferred)**

Plugin shows native Obsidian notification:

```typescript
// In Obsidian plugin
new Notice("✓ Task completed successfully");
```

Simple, native, non-intrusive.

**Option 2: System Notification (Fallback)**

If Obsidian is not focused or plugin not running:

```typescript
// In daemon
notifier.notify({
  title: 'Spark',
  message: 'Task completed successfully',
  sound: true,
  wait: false
});
```

Uses native OS notifications (macOS Notification Center, Windows Action Center, Linux notify-send).

**Decision: Use both**
- Try Obsidian toast first (write to notifications.jsonl)
- If urgent/error, also send system notification
- User can configure in settings

---

## Error Handling

### Error Flow

```
1. Daemon detects error during execution
2. Write detailed error to temp log file
3. Write notification with link to log
4. Update status indicator in file
5. User clicks notification to see details
```

### Error Categories

#### 1. Syntax Errors

User typed invalid syntax.

**Example:**
```markdown
@betty review @nonexistent.md
```

**File doesn't exist.**

**Behavior:**
```markdown
❌ @betty review @nonexistent.md
```

**Notification:**
```json
{
  "type": "error",
  "message": "File not found: @nonexistent.md",
  "link": ".spark/logs/error-abc123.md"
}
```

**Error log file:** `.spark/logs/error-abc123.md`
```markdown
# Error Report

**Time:** 2024-01-15 14:30:00
**File:** /vault/notes/2024-01-15.md
**Line:** 42

## Error
File not found: @nonexistent.md

## Command
@betty review @nonexistent.md

## Details
Attempted to resolve path:
- Checked: /vault/nonexistent.md (not found)
- Checked: /vault/notes/nonexistent.md (not found)
- Checked: /vault/finance/nonexistent.md (not found)

## Suggestion
Did you mean one of these?
- @compliance-rules.md
- @financial-rules.md
```

#### 2. AI/API Errors

Claude API fails (rate limit, network error, etc.)

**Behavior:**
```markdown
⚠️ @betty review @finance/Q4/
```

**Notification:**
```json
{
  "type": "warning",
  "message": "Rate limit exceeded. Retrying in 60s...",
  "link": ".spark/logs/error-def456.md"
}
```

**Error log file:** `.spark/logs/error-def456.md`
```markdown
# Error Report

**Time:** 2024-01-15 14:30:00
**File:** /vault/notes/2024-01-15.md
**Line:** 42

## Error
Rate limit exceeded (429)

## Command
@betty review @finance/Q4/

## Details
API Response:
```
{
  "error": {
    "type": "rate_limit_error",
    "message": "Rate limit exceeded. Retry after 60 seconds"
  }
}
```

## Action Taken
Automatically retrying in 60 seconds (attempt 1/3)

## Status
⏳ Waiting to retry...
```

#### 3. MCP Server Errors

External service unavailable.

**Behavior:**
```markdown
❌ @betty compare with $quickbooks
```

**Notification:**
```json
{
  "type": "error",
  "message": "QuickBooks service unavailable",
  "link": ".spark/logs/error-ghi789.md",
  "action": {
    "label": "Check MCP Config",
    "command": "spark:check-mcp-quickbooks"
  }
}
```

**Error log file:** `.spark/logs/error-ghi789.md`
```markdown
# Error Report

**Time:** 2024-01-15 14:30:00
**File:** /vault/notes/2024-01-15.md
**Line:** 42

## Error
MCP server 'quickbooks' not responding

## Command
@betty compare with $quickbooks

## Details
Attempted to connect to: mcp-quickbooks
Connection timeout after 30 seconds

## Troubleshooting
1. Check if MCP server is running:
   ```bash
   mcp-quickbooks --health
   ```

2. Check configuration:
   File: .spark/integrations/quickbooks/config.yaml
   
3. Restart MCP server:
   ```bash
   pkill mcp-quickbooks
   mcp-quickbooks &
   ```

4. Test connection:
   ```bash
   spark config test-mcp quickbooks
   ```
```

#### 4. File System Errors

Permission denied, disk full, etc.

**Behavior:**
```markdown
❌ /create-report
```

**Notification:**
```json
{
  "type": "error",
  "message": "Cannot write to reports/ - permission denied",
  "link": ".spark/logs/error-jkl012.md"
}
```

### Error Log Format

All errors written to timestamped files in `.spark/logs/`:

```
.spark/logs/
├── error-2024-01-15-143000-abc123.md
├── error-2024-01-15-143045-def456.md
└── error-2024-01-15-143120-ghi789.md
```

**Filename pattern:** `error-{timestamp}-{id}.md`

### Error Log Cleanup

Automatically delete old error logs:

```yaml
# .spark/config.yaml
logging:
  error_logs:
    max_age_days: 7      # Delete errors older than 7 days
    max_count: 100       # Keep max 100 error files
```

---

## Retry Logic

### Automatic Retries

For transient errors (network, rate limits):

```typescript
interface RetryConfig {
  enabled: boolean;
  maxAttempts: number;
  backoffMs: number;
  backoffMultiplier: number;
}

const retryConfig = {
  enabled: true,
  maxAttempts: 3,
  backoffMs: 1000,
  backoffMultiplier: 2
};

// Retry schedule:
// Attempt 1: immediate
// Attempt 2: after 1s
// Attempt 3: after 2s
// Attempt 4: after 4s
```

**Status indicator during retry:**

```markdown
⏳ @betty review @finance/Q4/
```

**Notification:**
```json
{
  "type": "info",
  "message": "Retrying... (attempt 2/3)",
  "progress": 0.66
}
```

### Manual Retry

User can manually retry by:

1. **Removing status emoji:**
   ```markdown
   ❌ @betty review @finance/Q4/
   ```
   Change to:
   ```markdown
   @betty review @finance/Q4/
   ```

2. **Or using retry command:**
   ```markdown
   /retry
   ```

---

## Progress Indicators

For long-running operations:

**Status in file:**
```markdown
⏳ @betty review @finance/Q4/
```

**Notification with progress:**
```json
{
  "type": "progress",
  "message": "Processing 15 files... (8/15)",
  "progress": 0.53,
  "timestamp": 1234567890
}
```

**Toast with progress bar:**
```
┌─────────────────────────────────┐
│ Processing files...             │
│ ▓▓▓▓▓▓▓▓▓▓░░░░░░░░░ 53%        │
└─────────────────────────────────┘
```

---

## Configuration

### Notification Settings

```yaml
# .spark/config.yaml
notifications:
  # Where to show notifications
  obsidian_toast: true        # Show in Obsidian
  system_notification: false  # Show OS notification
  system_on_error: true       # OS notification only for errors
  
  # What to show
  show_success: true
  show_info: false
  show_warnings: true
  show_errors: true
  show_progress: true
  
  # Behavior
  auto_dismiss_success_ms: 3000
  auto_dismiss_error_ms: 10000
  sound_on_error: true
  
  # Error logs
  error_logs:
    path: .spark/logs/
    max_age_days: 7
    max_count: 100
    include_stack_trace: true

# Retry settings
retry:
  enabled: true
  max_attempts: 3
  backoff_ms: 1000
  backoff_multiplier: 2
  
  # What errors to retry
  retry_on:
    - rate_limit
    - network_timeout
    - service_unavailable
  
  # What errors to never retry
  never_retry:
    - syntax_error
    - file_not_found
    - permission_denied
```

---

## Summary

### Result Handling
✅ **Simple:** Just add ✅ to indicate completion  
✅ **The action IS the result:** Modified files, created reports, sent emails  
✅ **Only write inline when command explicitly requests it**

### Error Handling
✅ **Detailed logs:** Full error context in temp file  
✅ **User-friendly notifications:** Simple message with link to details  
✅ **Automatic retry:** For transient errors  
✅ **Manual retry:** User can try again by removing ❌

### Notification Strategy
✅ **Obsidian toast first:** Native, non-intrusive  
✅ **System notification for errors:** When Obsidian not focused  
✅ **Configurable:** User can customize what they see

**This keeps the system simple while providing rich error information when needed.**

---

## Next Steps

With result/error handling defined, we need to spec:
1. **Plugin UI details** - Command palette behavior, chat widget layout
2. **Implementation phases** - What to build first, testing strategy
3. **Installation/setup** - How users install and configure Spark

Which should we detail next?
